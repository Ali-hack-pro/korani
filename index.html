<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الحضور والغياب</title>
  <style>
    body {
      font-family: 'Tahoma', sans-serif;
      background-color: #f3f3f3;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #333;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: 16px;
      max-width: 400px;
      margin: 0 auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    input, select, button {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      cursor: pointer;
      border: none;
      color: white;
      font-weight: bold;
    }

    .attendance-btn {
      background-color: #4CAF50;
    }

    .absence-btn {
      background-color: #E53935;
    }

    #status {
      margin-top: 10px;
      font-weight: bold;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    .attendance-item {
      background-color: #e8f5e9;
      color: #2e7d32;
      margin: 6px 0;
      padding: 10px;
      border-radius: 10px;
    }

    .absence-item {
      background-color: #ffebee;
      color: #c62828;
      margin: 6px 0;
      padding: 10px;
      border-radius: 10px;
    }

    .student-name {
      font-weight: bold;
    }

    .timestamp {
      display: block;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>نظام تسجيل الحضور والغياب</h1>

  <div class="form-container">
    <input type="text" id="firstName" placeholder="الاسم الأول">
    <input type="text" id="lastName" placeholder="الاسم الثاني">
    <input type="text" id="classIdentifier" placeholder="اسم الصف / المعلمة">

    <button class="attendance-btn" onclick="submitAttendance('attendance')">تسجيل حضور</button>
    <button class="absence-btn" onclick="submitAttendance('absence')">تسجيل غياب</button>

    <div id="status"></div>
  </div>

  <h2>قائمة الحضور والغياب</h2>
  <ul id="attendanceList"></ul>

  <script>
    // ضع هنا رابط Google Apps Script الذي نشرته (web app)
    const API_URL = "https://script.google.com/macros/s/AKfycby58GdjjpPFXdmeqDwhomlvphVNY2_ycBQ59kWbZbxwcTsCTtJq-0D5tEp1mNHJnPQIXw/exec";

    async function submitAttendance(type) {
      const firstName = document.getElementById("firstName").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      const classIdentifier = document.getElementById("classIdentifier").value.trim();
      const statusDiv = document.getElementById("status");

      if (!firstName || !lastName || !classIdentifier) {
        statusDiv.innerText = "الرجاء تعبئة جميع الحقول!";
        statusDiv.style.color = "red";
        return;
      }

      const now = new Date();
      const timeString = now.toLocaleString("ar-EG");
      const status = type === "attendance" ? "Present" : "Absent";

      const url = `${API_URL}?action=add&first=${encodeURIComponent(firstName)}&second=${encodeURIComponent(lastName)}&class=${encodeURIComponent(classIdentifier)}&time=${encodeURIComponent(timeString)}&status=${encodeURIComponent(status)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.status === "success") {
          statusDiv.innerText = "✅ تم تسجيل " + (status === "Present" ? "الحضور" : "الغياب") + " بنجاح!";
          statusDiv.style.color = "green";
          fetchAttendance();
        } else {
          statusDiv.innerText = "⚠️ حدث خطأ أثناء التسجيل!";
          statusDiv.style.color = "red";
        }
      } catch (error) {
        statusDiv.innerText = "⚠️ لم يتم الاتصال بالخادم.";
        statusDiv.style.color = "red";
      }
    }

    async function fetchAttendance() {
      const list = document.getElementById("attendanceList");
      list.innerHTML = "<li>جاري التحميل...</li>";

      try {
        const res = await fetch(`${API_URL}?action=get`);
        const data = await res.json();

        list.innerHTML = "";

        if (!data || data.length === 0) {
          list.innerHTML = "<li>لا توجد بيانات حتى الآن.</li>";
          return;
        }

        // عرض الأحدث أولاً
        data.reverse().forEach(student => {
          const li = document.createElement("li");
          li.className = student.status === "Absent" ? "absence-item" : "attendance-item";
          li.innerHTML = `
            <span class="student-name">${student.first} ${student.second}</span>
            <span class="timestamp">${student.time} (${student.status === "Absent" ? "غياب" : "حضور"})</span>
          `;
          list.appendChild(li);
        });
      } catch (error) {
        list.innerHTML = "<li>⚠️ تعذر تحميل البيانات من الشيت.</li>";
      }
    }

    // تحميل البيانات عند فتح الصفحة
    fetchAttendance();
  </script>
</body>
</html>
